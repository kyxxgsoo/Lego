<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ€ ê´€ë¦¬ - Lego</title>
    <script src="users-data.js"></script>
    <script src="projects-data.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        :root {
            --bg-gray: #f4f6f8;
            --border-color: #e5e7eb;
            --primary-blue: #2563eb;
            --text-dark: #1e293b;
            --task-blue-bg: #dbeafe; --task-blue-text: #1e40af; --task-blue-border: #3b82f6;
            --task-green-bg: #dcfce7; --task-green-text: #166534; --task-green-border: #22c55e;
            --task-yellow-bg: #fef9c3; --task-yellow-text: #854d0e; --task-yellow-border: #eab308;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-gray);
            color: var(--text-dark);
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #0f766e 0%, #0d9488 100%);
            padding: 30px 20px;
            overflow-y: auto;
            z-index: 100;
        }

        .logo {
            color: white;
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .logo-subtitle {
            color: #ccfbf1;
            font-size: 0.85rem;
            margin-bottom: 30px;
        }

        .user-profile {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 30px;
            color: white;
        }

        .user-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .user-role {
            font-size: 0.85rem;
            color: #ccfbf1;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #ccfbf1;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content {
            margin-left: 260px;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 1.8rem;
            color: var(--text-dark);
        }

        /* í•„í„° ì„¹ì…˜ */
        .filter-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        /* íŒ€ì› ê·¸ë¦¬ë“œ */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .team-member-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .member-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .member-dept {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        /* ë‚ ì§œ ê·¸ë¦¬ë“œ */
        .date-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 10px;
        }

        .date-cell {
            aspect-ratio: 1;
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #64748b;
        }

        .date-cell.has-tasks {
            background: white;
        }

        .date-number {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .category-blocks {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
            width: 100%;
            padding: 2px;
        }

        .category-block {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .category-block.planning {
            background: var(--task-blue-border);
        }

        .category-block.development {
            background: var(--task-green-border);
        }

        .category-block.design {
            background: var(--task-yellow-border);
        }

        .weekday-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .weekday-cell {
            text-align: center;
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
            padding: 4px;
        }
    </style>
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
        <div class="logo">ğŸ§± Lego</div>
        <div class="logo-subtitle">íŒ€ì¥ ëŒ€ì‹œë³´ë“œ</div>

        <div class="user-profile">
            <div class="user-name" id="userName">íŒ€ì¥</div>
            <div class="user-role" id="userTeam">Team Lead</div>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a href="teamlead.html" class="nav-link">
                    <span>ğŸ“Š</span> íŒ€ì¥ ëŒ€ì‹œë³´ë“œ
                </a>
            </li>
            <li class="nav-item">
                <a href="my_calendar.html" class="nav-link">
                    <span>ğŸ“†</span> ë‚´ ìº˜ë¦°ë”
                </a>
            </li>
            <li class="nav-item">
                <a href="entire_calendar.html" class="nav-link">
                    <span>ğŸ“…</span> ì „ì²´ ìº˜ë¦°ë”
                </a>
            </li>
            <li class="nav-item">
                <a href="project_register.html" class="nav-link">
                    <span>ğŸ“„</span> í”„ë¡œì íŠ¸ ë“±ë¡
                </a>
            </li>
            <li class="nav-item">
                <a href="task_schedule.html" class="nav-link">
                    <span>ğŸ“‹</span> í…ŒìŠ¤í¬ ê´€ë¦¬
                </a>
            </li>
            <li class="nav-item">
                <a href="team_manage.html" class="nav-link active">
                    <span>ğŸ¢</span> íŒ€ ê´€ë¦¬
                </a>
            </li>
        </ul>

        <button class="logout-btn" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </aside>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content">
        <div class="header">
            <h1>ğŸ¢ íŒ€ ê´€ë¦¬</h1>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label>í”„ë¡œì íŠ¸ ì„ íƒ</label>
                    <select id="projectSelect">
                        <option value="all">ì „ì²´ í”„ë¡œì íŠ¸</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ì›” ì„ íƒ</label>
                    <select id="monthSelect">
                        <!-- ë™ì  ìƒì„± -->
                    </select>
                </div>
            </div>
        </div>

        <!-- íŒ€ì› ê·¸ë¦¬ë“œ -->
        <div class="team-grid" id="teamGrid">
            <!-- ë™ì  ìƒì„± -->
        </div>
    </main>

    <script>
        // ë¡œê·¸ì¸ ì²´í¬
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.name;
            const teamNames = {
                'dev': 'ê°œë°œíŒ€',
                'design': 'ë””ìì¸íŒ€',
                'planning': 'ê¸°íšíŒ€'
            };
            document.getElementById('userTeam').textContent = teamNames[currentUser.team] || 'íŒ€ì¥';
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // ë°ì´í„° ë³€ìˆ˜
        let USERS = {};
        let CATEGORIES = {};
        let TASKS = {};
        let TASK_ASSIGNMENTS = [];
        let PROJECTS = [];

        // ì¹´í…Œê³ ë¦¬ ë§¤í•‘
        function getCategoryFromMajor(ëŒ€ë¶„ë¥˜) {
            if (!ëŒ€ë¶„ë¥˜) return 'planning';
            if (ëŒ€ë¶„ë¥˜.includes('ê¸°íš') || ëŒ€ë¶„ë¥˜.includes('í–‰ì‚¬') || ëŒ€ë¶„ë¥˜.includes('ê²½ì˜') || ëŒ€ë¶„ë¥˜.includes('ì¬ë¬´')) {
                return 'planning';
            } else if (ëŒ€ë¶„ë¥˜.includes('ê°œë°œ') || ëŒ€ë¶„ë¥˜.includes('AI')) {
                return 'development';
            } else if (ëŒ€ë¶„ë¥˜.includes('ë””ìì¸') || ëŒ€ë¶„ë¥˜.includes('ì‹œê°')) {
                return 'design';
            }
            return 'planning';
        }

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            // ì‚¬ìš©ì ë°ì´í„°
            if (typeof USERS_DATA !== 'undefined') {
                USERS = {};
                USERS_DATA.users.forEach(user => {
                    USERS[user.id] = { name: user.name, team: user.team };
                });
                CATEGORIES = USERS_DATA.categories || {};
            }

            // í”„ë¡œì íŠ¸ ë°ì´í„°
            if (typeof PROJECTS_DATA !== 'undefined') {
                PROJECTS = PROJECTS_DATA.projects || [];
                TASKS = {};
                PROJECTS_DATA.tasks.forEach(task => {
                    TASKS[task.id] = {
                        taskId: task.id,
                        title: task.ì†Œë¶„ë¥˜ || task.ì¤‘ë¶„ë¥˜,
                        category: getCategoryFromMajor(task.ëŒ€ë¶„ë¥˜),
                        projectId: task.projectId,
                        totalHours: task.ê¸°ì¤€ì‹œê°„ || 0
                    };
                });
            }

            // ìŠ¤ì¼€ì¤„ ë°ì´í„° ë¡œë“œ
            await loadSchedulesFromLocalStorage();

            // í”„ë¡œì íŠ¸ ì„ íƒ ì˜µì…˜ ìƒì„±
            const projectSelect = document.getElementById('projectSelect');
            PROJECTS.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                projectSelect.appendChild(option);
            });

            // ì›” ì„ íƒ ì˜µì…˜ ìƒì„± (ìµœê·¼ 12ê°œì›”)
            const monthSelect = document.getElementById('monthSelect');
            const today = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const option = document.createElement('option');
                option.value = `${year}-${String(month).padStart(2, '0')}`;
                option.textContent = `${year}ë…„ ${month}ì›”`;
                if (i === 0) option.selected = true;
                monthSelect.appendChild(option);
            }

            // ì´ˆê¸° ë Œë”ë§
            renderTeamGrid();
        }

        // localStorageì—ì„œ ìŠ¤ì¼€ì¤„ ë¡œë“œ
        async function loadSchedulesFromLocalStorage() {
            const saved = localStorage.getItem('projectSchedules');
            if (!saved) return;

            try {
                const data = JSON.parse(saved);
                const schedules = data.schedules || [];

                // ì‚¬ìš©ì ë§¤í•‘
                const userMapping = {};
                if (typeof USERS_DATA !== 'undefined') {
                    USERS_DATA.users.forEach(user => {
                        userMapping[user.name] = user.id;
                    });
                }

                TASK_ASSIGNMENTS = [];
                schedules.forEach(schedule => {
                    const task = schedule.task || {};
                    const userName = schedule.userName || schedule.user;
                    const userId = userMapping[userName] || schedule.user;

                    if (!userId) return;

                    const category = getCategoryFromMajor(task.ëŒ€ë¶„ë¥˜ || '');
                    const hours = schedule.assignedHours || calculateHours(schedule.startTime, schedule.endTime, schedule.startDate, schedule.endDate);

                    TASK_ASSIGNMENTS.push({
                        taskId: schedule.taskId,
                        user: userId,
                        startDate: schedule.startDate,
                        endDate: schedule.endDate,
                        startTime: schedule.startTime,
                        endTime: schedule.endTime,
                        assignedHours: hours,
                        category: category,
                        projectId: task.projectId || schedule.task?.projectId || 'project-unknown'
                    });
                });
            } catch (error) {
                console.error('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì‹œê°„ ê³„ì‚°
        function calculateHours(startTime, endTime, startDate, endDate) {
            const start = new Date(`${startDate}T${startTime}`);
            const end = new Date(`${endDate}T${endTime}`);
            return (end - start) / (1000 * 60 * 60);
        }

        // íŠ¹ì • ë‚ ì§œì˜ ìŠ¤ì¼€ì¤„ ê°€ì ¸ì˜¤ê¸°
        function getSchedulesForDate(dateStr, userId, projectId) {
            return TASK_ASSIGNMENTS.filter(assignment => {
                if (userId && assignment.user !== userId) return false;
                if (projectId && projectId !== 'all' && assignment.projectId !== projectId) return false;

                const targetDate = new Date(dateStr);
                const startDate = new Date(assignment.startDate);
                const endDate = new Date(assignment.endDate);

                return targetDate >= startDate && targetDate <= endDate;
            });
        }

        // íŠ¹ì • ë‚ ì§œì˜ ì§€ë°°ì  ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
        function getDominantCategory(dateStr, userId, projectId) {
            const schedules = getSchedulesForDate(dateStr, userId, projectId);
            if (schedules.length === 0) return null;

            // ì¹´í…Œê³ ë¦¬ë³„ ì‹œê°„ í•©ê³„
            const categoryHours = {};
            schedules.forEach(schedule => {
                const category = schedule.category || 'planning';
                const hours = schedule.assignedHours || 0;
                categoryHours[category] = (categoryHours[category] || 0) + hours;
            });

            // ê°€ì¥ ë§ì€ ì‹œê°„ì„ ì°¨ì§€í•˜ëŠ” ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
            let dominantCategory = null;
            let maxHours = 0;
            Object.keys(categoryHours).forEach(category => {
                if (categoryHours[category] > maxHours) {
                    maxHours = categoryHours[category];
                    dominantCategory = category;
                }
            });

            return dominantCategory;
        }

        // ì›”ì˜ ëª¨ë“  ë‚ ì§œì— ëŒ€í•œ ì¹´í…Œê³ ë¦¬ ë¸”ë¡ ìƒì„±
        function getCategoryBlocksForMonth(year, month, userId, projectId) {
            const lastDate = new Date(year, month, 0).getDate();
            const blocks = [];

            for (let date = 1; date <= lastDate; date++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const category = getDominantCategory(dateStr, userId, projectId);
                blocks.push({
                    date: date,
                    dateStr: dateStr,
                    category: category
                });
            }

            return blocks;
        }

        // íŒ€ì› ê·¸ë¦¬ë“œ ë Œë”ë§
        function renderTeamGrid() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const selectedProject = document.getElementById('projectSelect').value;
            const [year, month] = selectedMonth.split('-').map(Number);

            // í˜„ì¬ ì‚¬ìš©ìì˜ íŒ€ì›ë§Œ í•„í„°ë§
            const teamMembers = [];
            if (typeof USERS_DATA !== 'undefined') {
                USERS_DATA.users.forEach(user => {
                    if (user.team === currentUser.team && user.role === 'user') {
                        teamMembers.push(user);
                    }
                });
            }

            const teamGrid = document.getElementById('teamGrid');
            teamGrid.innerHTML = '';

            teamMembers.forEach(member => {
                const blocks = getCategoryBlocksForMonth(year, month, member.id, selectedProject);
                const card = createMemberCard(member, blocks, year, month);
                teamGrid.appendChild(card);
            });
        }

        // íŒ€ì› ì¹´ë“œ ìƒì„±
        function createMemberCard(member, blocks, year, month) {
            const card = document.createElement('div');
            card.className = 'team-member-card';

            const firstDay = new Date(year, month - 1, 1);
            const firstDayOfWeek = firstDay.getDay();
            const lastDate = new Date(year, month, 0).getDate();

            // ìš”ì¼ í—¤ë”
            const weekdayHeader = document.createElement('div');
            weekdayHeader.className = 'weekday-header';
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            weekdays.forEach(day => {
                const cell = document.createElement('div');
                cell.className = 'weekday-cell';
                cell.textContent = day;
                weekdayHeader.appendChild(cell);
            });

            // ë‚ ì§œ ê·¸ë¦¬ë“œ
            const dateGrid = document.createElement('div');
            dateGrid.className = 'date-grid';

            // ì²« ì£¼ì˜ ë¹ˆ ì…€
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'date-cell';
                dateGrid.appendChild(emptyCell);
            }

            // ë‚ ì§œ ì…€
            blocks.forEach(block => {
                const cell = document.createElement('div');
                cell.className = 'date-cell';
                if (block.category) {
                    cell.classList.add('has-tasks');
                }

                const dateNumber = document.createElement('div');
                dateNumber.className = 'date-number';
                dateNumber.textContent = block.date;
                cell.appendChild(dateNumber);

                if (block.category) {
                    const categoryBlocks = document.createElement('div');
                    categoryBlocks.className = 'category-blocks';
                    const blockEl = document.createElement('div');
                    blockEl.className = `category-block ${block.category}`;
                    categoryBlocks.appendChild(blockEl);
                    cell.appendChild(categoryBlocks);
                }

                dateGrid.appendChild(cell);
            });

            // ë©¤ë²„ í—¤ë”
            const memberHeader = document.createElement('div');
            memberHeader.className = 'member-header';
            const memberInfo = document.createElement('div');
            const memberName = document.createElement('div');
            memberName.className = 'member-name';
            memberName.textContent = member.name;
            const memberDept = document.createElement('div');
            memberDept.className = 'member-dept';
            memberDept.textContent = member.department || member.affiliation || '';
            memberInfo.appendChild(memberName);
            memberInfo.appendChild(memberDept);
            memberHeader.appendChild(memberInfo);

            card.appendChild(memberHeader);
            card.appendChild(weekdayHeader);
            card.appendChild(dateGrid);

            return card;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('projectSelect').addEventListener('change', renderTeamGrid);
        document.getElementById('monthSelect').addEventListener('change', renderTeamGrid);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>

