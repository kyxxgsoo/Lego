<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ€ ê´€ë¦¬ - Lego</title>
    <script src="users-data.js"></script>
    <script src="projects-data.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        :root {
            --bg-gray: #f4f6f8;
            --border-color: #e5e7eb;
            --primary-blue: #2563eb;
            --text-dark: #1e293b;
            --task-blue-bg: #dbeafe; --task-blue-text: #1e40af; --task-blue-border: #3b82f6;
            --task-green-bg: #dcfce7; --task-green-text: #166534; --task-green-border: #22c55e;
            --task-yellow-bg: #fef9c3; --task-yellow-text: #854d0e; --task-yellow-border: #eab308;
            --task-purple-bg: #f3e8ff; --task-purple-text: #6b21a8; --task-purple-border: #a855f7;
            --task-orange-bg: #ffedd5; --task-orange-text: #9a3412; --task-orange-border: #f97316;
            --task-pink-bg: #fce7f3; --task-pink-text: #9f1239; --task-pink-border: #ec4899;
            --task-cyan-bg: #cffafe; --task-cyan-text: #164e63; --task-cyan-border: #06b6d4;
            --task-indigo-bg: #e0e7ff; --task-indigo-text: #3730a3; --task-indigo-border: #6366f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-gray);
            color: var(--text-dark);
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #0f766e 0%, #0d9488 100%);
            padding: 30px 20px;
            overflow-y: auto;
            z-index: 100;
        }

        .logo {
            color: white;
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .logo-subtitle {
            color: #ccfbf1;
            font-size: 0.85rem;
            margin-bottom: 30px;
        }

        .user-profile {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 30px;
            color: white;
        }

        .user-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .user-role {
            font-size: 0.85rem;
            color: #ccfbf1;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #ccfbf1;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content {
            margin-left: 260px;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 1.8rem;
            color: var(--text-dark);
        }

        /* í•„í„° ì„¹ì…˜ */
        .filter-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        /* íŒ€ì› ê·¸ë¦¬ë“œ */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .team-member-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .member-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .member-dept {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        /* ë‚ ì§œ ê·¸ë¦¬ë“œ */
        .date-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 10px;
        }

        .date-cell {
            aspect-ratio: 1;
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #64748b;
            transition: all 0.2s;
        }

        .date-cell.has-tasks {
            background: white;
        }

        .date-cell.category-planning {
            background: var(--task-blue-bg) !important;
            border-color: var(--task-blue-border);
            color: var(--task-blue-text);
        }

        .date-cell.category-development {
            background: var(--task-green-bg) !important;
            border-color: var(--task-green-border);
            color: var(--task-green-text);
        }

        .date-cell.category-design {
            background: var(--task-yellow-bg) !important;
            border-color: var(--task-yellow-border);
            color: var(--task-yellow-text);
        }

        .date-cell.category-marketing {
            background: var(--task-purple-bg) !important;
            border-color: var(--task-purple-border);
            color: var(--task-purple-text);
        }

        .date-cell.category-operation {
            background: var(--task-orange-bg) !important;
            border-color: var(--task-orange-border);
            color: var(--task-orange-text);
        }

        .date-cell.category-qa {
            background: var(--task-pink-bg) !important;
            border-color: var(--task-pink-border);
            color: var(--task-pink-text);
        }

        .date-cell.category-finance {
            background: var(--task-cyan-bg) !important;
            border-color: var(--task-cyan-border);
            color: var(--task-cyan-text);
        }

        .date-cell.category-hr {
            background: var(--task-indigo-bg) !important;
            border-color: var(--task-indigo-border);
            color: var(--task-indigo-text);
        }

        .date-number {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .weekday-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .weekday-cell {
            text-align: center;
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
            padding: 4px;
        }
    </style>
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
        <div class="logo">ğŸ§± Lego</div>
        <div class="logo-subtitle">íŒ€ì¥ ëŒ€ì‹œë³´ë“œ</div>

        <div class="user-profile">
            <div class="user-name" id="userName">íŒ€ì¥</div>
            <div class="user-role" id="userTeam">Team Lead</div>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a href="teamlead.html" class="nav-link">
                    <span>ğŸ“Š</span> íŒ€ì¥ ëŒ€ì‹œë³´ë“œ
                </a>
            </li>
            <li class="nav-item">
                <a href="my_calendar.html" class="nav-link">
                    <span>ğŸ“†</span> ë‚´ ìº˜ë¦°ë”
                </a>
            </li>
            <li class="nav-item">
                <a href="entire_calendar.html" class="nav-link">
                    <span>ğŸ“…</span> ì „ì²´ ìº˜ë¦°ë”
                </a>
            </li>
            <li class="nav-item">
                <a href="project_register.html" class="nav-link">
                    <span>ğŸ“„</span> í”„ë¡œì íŠ¸ ë“±ë¡
                </a>
            </li>
            <li class="nav-item">
                <a href="task_schedule.html" class="nav-link">
                    <span>ğŸ“‹</span> í…ŒìŠ¤í¬ ê´€ë¦¬
                </a>
            </li>
            <li class="nav-item">
                <a href="team_manage.html" class="nav-link active">
                    <span>ğŸ¢</span> íŒ€ ê´€ë¦¬
                </a>
            </li>
        </ul>

        <button class="logout-btn" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </aside>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content">
        <div class="header">
            <h1>ğŸ¢ íŒ€ ê´€ë¦¬</h1>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label>í”„ë¡œì íŠ¸ ì„ íƒ</label>
                    <select id="projectSelect">
                        <option value="all">ì „ì²´ í”„ë¡œì íŠ¸</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ì›” ì„ íƒ</label>
                    <select id="monthSelect">
                        <!-- ë™ì  ìƒì„± -->
                    </select>
                </div>
            </div>
        </div>

        <!-- íŒ€ì› ê·¸ë¦¬ë“œ -->
        <div class="team-grid" id="teamGrid">
            <!-- ë™ì  ìƒì„± -->
        </div>
    </main>

    <script>
        // ë¡œê·¸ì¸ ì²´í¬
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.name;
            const teamNames = {
                'dev': 'ê°œë°œíŒ€',
                'design': 'ë””ìì¸íŒ€',
                'planning': 'ê¸°íšíŒ€'
            };
            document.getElementById('userTeam').textContent = teamNames[currentUser.team] || 'íŒ€ì¥';
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // ë°ì´í„° ë³€ìˆ˜
        let USERS = {};
        let CATEGORIES = {};
        let TASKS = {};
        let TASK_ASSIGNMENTS = [];
        let PROJECTS = [];

        // ì¹´í…Œê³ ë¦¬ ë§¤í•‘
        function getCategoryFromMajor(ëŒ€ë¶„ë¥˜) {
            if (!ëŒ€ë¶„ë¥˜) return 'planning';
            if (ëŒ€ë¶„ë¥˜.includes('ê¸°íš') || ëŒ€ë¶„ë¥˜.includes('í–‰ì‚¬') || ëŒ€ë¶„ë¥˜.includes('ê²½ì˜')) {
                return 'planning';
            } else if (ëŒ€ë¶„ë¥˜.includes('ê°œë°œ') || ëŒ€ë¶„ë¥˜.includes('AI')) {
                return 'development';
            } else if (ëŒ€ë¶„ë¥˜.includes('ë””ìì¸') || ëŒ€ë¶„ë¥˜.includes('ì‹œê°')) {
                return 'design';
            } else if (ëŒ€ë¶„ë¥˜.includes('ë§ˆì¼€íŒ…')) {
                return 'marketing';
            } else if (ëŒ€ë¶„ë¥˜.includes('ìš´ì˜')) {
                return 'operation';
            } else if (ëŒ€ë¶„ë¥˜.includes('QA') || ëŒ€ë¶„ë¥˜.includes('í…ŒìŠ¤íŠ¸')) {
                return 'qa';
            } else if (ëŒ€ë¶„ë¥˜.includes('ì¬ë¬´')) {
                return 'finance';
            } else if (ëŒ€ë¶„ë¥˜.includes('ì¸ì‚¬')) {
                return 'hr';
            }
            return 'planning';
        }

        // entire_calendar.htmlê³¼ ë™ì¼í•œ ì¼ì • ìƒì„± í•¨ìˆ˜ ì‚¬ìš©
        function createSampleSchedulesForEntireCalendar() {
            // PROJECTS_DATAê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ëŒ€ê¸°
            if (typeof PROJECTS_DATA === 'undefined' || !PROJECTS_DATA.tasks) {
                console.warn('âš ï¸ PROJECTS_DATAê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const baseDate = new Date('2025-12-01');
            const schedules = [];
            
            // ì‚¬ìš©ì ë§¤í•‘ (ì´ë¦„ -> user ID)
            const userMapping = {};
            if (typeof USERS_DATA !== 'undefined') {
                USERS_DATA.users.forEach(user => {
                    userMapping[user.name] = user.id;
                });
            }
            
            // ê¸°ì¡´ ì¼ì • ë¡œë“œ (ì¤‘ë³µ ë°©ì§€ìš©)
            const existing = localStorage.getItem('projectSchedules');
            const existingSchedules = new Set();
            if (existing) {
                try {
                    const data = JSON.parse(existing);
                    if (data.schedules && Array.isArray(data.schedules)) {
                        data.schedules.forEach(s => {
                            // taskId + userName + startDate + startTimeìœ¼ë¡œ ê³ ìœ  í‚¤ ìƒì„±
                            const key = `${s.taskId}-${s.userName || s.user}-${s.startDate}-${s.startTime}`;
                            existingSchedules.add(key);
                        });
                        console.log(`ğŸ“‹ ê¸°ì¡´ ì¼ì • ${data.schedules.length}ê°œ ë°œê²¬, ì¤‘ë³µ ì²´í¬ ì§„í–‰`);
                    }
                } catch (e) {
                    console.warn('âš ï¸ ê¸°ì¡´ ì¼ì • íŒŒì‹± ì˜¤ë¥˜:', e);
                }
            }
            
            // PROJECTS_DATAì˜ ëª¨ë“  í…ŒìŠ¤í¬ ì¤‘ í• ë‹¹ì‹œê°„ì´ ìˆëŠ” ê²ƒë§Œ í•„í„°ë§
            const tasksWithAssignment = PROJECTS_DATA.tasks.filter(task => 
                task.í• ë‹¹ì‹œê°„ && task.í• ë‹¹ì‹œê°„ > 0 && task.ì´ë¦„ && task.ì´ë¦„.trim() !== ''
            );
            
            console.log(`ğŸ“‹ í• ë‹¹ëœ í…ŒìŠ¤í¬ ë°œê²¬: ${tasksWithAssignment.length}ê°œ`);
            
            let dateOffset = 0;
            let newScheduleCount = 0;
            
            tasksWithAssignment.forEach((task, index) => {
                const userName = task.ì´ë¦„;
                const userId = userMapping[userName];
                
                if (!userId) {
                    console.warn(`âš ï¸ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${userName} (í…ŒìŠ¤í¬: ${task.id})`);
                    return;
                }
                
                const assignedHours = task.í• ë‹¹ì‹œê°„;
                const standardHours = task.ê¸°ì¤€ì‹œê°„ || assignedHours;
                
                // ì¼ìˆ˜ ê³„ì‚° (í•˜ë£¨ ìµœëŒ€ 8ì‹œê°„ ê¸°ì¤€)
                const days = Math.max(1, Math.ceil(assignedHours / 8));
                const hoursPerDay = Math.ceil(assignedHours / days);
                
                // ë‚ ì§œ ë¶„ì‚° (ë‹¤ì–‘í•œ ë‚ ì§œì— ë°°ì¹˜)
                const startDate = new Date(baseDate);
                startDate.setDate(baseDate.getDate() + dateOffset);
                
                let remainingHours = assignedHours;
                let dayCount = 0;
                
                for (let day = 0; day < days && remainingHours > 0; day++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + day);
                    
                    // ì£¼ë§ ì œì™¸
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        continue;
                    }
                    
                    const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    
                    // ì‹œê°„ ê³„ì‚° (09:00ë¶€í„° ì‹œì‘, ìµœëŒ€ 18:00ê¹Œì§€)
                    const dayHours = Math.min(hoursPerDay, remainingHours, 8);
                    const startHour = 9;
                    const endHour = Math.min(startHour + dayHours, 18);
                    const startTime = `${String(startHour).padStart(2, '0')}:00`;
                    const endTime = `${String(endHour).padStart(2, '0')}:00`;
                    
                    // ì¤‘ë³µ ì²´í¬
                    const scheduleKey = `${task.id}-${userName}-${dateStr}-${startTime}`;
                    if (existingSchedules.has(scheduleKey)) {
                        console.log(`â­ï¸ ì¤‘ë³µ ì¼ì • ìŠ¤í‚µ: ${scheduleKey}`);
                        continue;
                    }
                    
                    schedules.push({
                        taskId: task.id,
                        userName: userName,
                        user: userId,
                        startDate: dateStr,
                        endDate: dateStr,
                        startTime: startTime,
                        endTime: endTime,
                        assignedHours: dayHours,
                        task: {
                            ì†Œë¶„ë¥˜: task.ì†Œë¶„ë¥˜ || task.ì¤‘ë¶„ë¥˜ || 'í…ŒìŠ¤í¬',
                            ì¤‘ë¶„ë¥˜: task.ì¤‘ë¶„ë¥˜ || 'ì‘ì—…',
                            ëŒ€ë¶„ë¥˜: task.ëŒ€ë¶„ë¥˜ || 'ê¸°íšê´€ë¦¬',
                            í• ë‹¹ì‹œê°„: dayHours,
                            ê¸°ì¤€ì‹œê°„: standardHours,
                            ë¹„ê³ : task.ë¹„ê³  || '',
                            projectId: task.projectId || 'project-unknown',
                            ì‚¬ì—…ëª…: task.ì‚¬ì—…ëª… || 'í”„ë¡œì íŠ¸'
                        }
                    });
                    
                    existingSchedules.add(scheduleKey);
                    newScheduleCount++;
                    remainingHours -= dayHours;
                    dayCount++;
                }
                
                // ë‹¤ìŒ í…ŒìŠ¤í¬ëŠ” ì ì ˆíˆ ë¶„ì‚° ë°°ì¹˜
                // ê°™ì€ ë‚ ì§œì— ì—¬ëŸ¬ í…ŒìŠ¤í¬ê°€ ë°°ì¹˜ë˜ì–´ ë‹¤ì–‘í•œ ìƒ‰ìƒì„ ë³¼ ìˆ˜ ìˆë„ë¡
                // í•˜ì§€ë§Œ ë„ˆë¬´ ë§ì´ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ê°™ì€ ë‚ ì§œì— ë°°ì¹˜
                if (dateOffset % 5 === 0) {
                    dateOffset += 1; // 5ê°œë§ˆë‹¤ 1ì¼ì”© ì´ë™
                } else {
                    dateOffset += 0; // ê°™ì€ ë‚ ì§œì— ë°°ì¹˜í•˜ì—¬ ë‹¤ì–‘í•œ ìƒ‰ìƒ í‘œì‹œ
                }
            });
            
            // ê¸°ì¡´ ì¼ì •ê³¼ ìƒˆ ì¼ì • ë³‘í•©
            let allSchedules = [];
            if (existing) {
                try {
                    const data = JSON.parse(existing);
                    if (data.schedules && Array.isArray(data.schedules)) {
                        allSchedules = data.schedules;
                    }
                } catch (e) {
                    console.warn('âš ï¸ ê¸°ì¡´ ì¼ì • ë³‘í•© ì˜¤ë¥˜:', e);
                }
            }
            
            // ìƒˆ ì¼ì • ì¶”ê°€
            allSchedules = allSchedules.concat(schedules);
            
            // localStorageì— ì €ì¥
            const scheduleData = {
                schedules: allSchedules,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('projectSchedules', JSON.stringify(scheduleData));
            console.log(`âœ… ìƒ˜í”Œ ì¼ì • ìƒì„± ì™„ë£Œ: ìƒˆ ì¼ì • ${newScheduleCount}ê°œ ì¶”ê°€ (ì „ì²´ ${allSchedules.length}ê°œ)`);
        }

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            // ì‚¬ìš©ì ë°ì´í„°
            if (typeof USERS_DATA !== 'undefined') {
                USERS = {};
                USERS_DATA.users.forEach(user => {
                    USERS[user.id] = { name: user.name, team: user.team };
                });
                CATEGORIES = USERS_DATA.categories || {};
            }

            // í”„ë¡œì íŠ¸ ë°ì´í„°
            if (typeof PROJECTS_DATA !== 'undefined') {
                PROJECTS = PROJECTS_DATA.projects || [];
                TASKS = {};
                PROJECTS_DATA.tasks.forEach(task => {
                    TASKS[task.id] = {
                        taskId: task.id,
                        title: task.ì†Œë¶„ë¥˜ || task.ì¤‘ë¶„ë¥˜,
                        category: getCategoryFromMajor(task.ëŒ€ë¶„ë¥˜),
                        projectId: task.projectId,
                        totalHours: task.ê¸°ì¤€ì‹œê°„ || 0
                    };
                });
            }

            // ìŠ¤ì¼€ì¤„ ë°ì´í„° ë¡œë“œ (entire_calendar.htmlì—ì„œ ìƒì„±ëœ ì¼ì • ì‚¬ìš©)
            // ì¼ì • ìƒì„±ì€ entire_calendar.htmlì—ì„œë§Œ ìˆ˜í–‰í•˜ê³ , ì—¬ê¸°ì„œëŠ” ì½ê¸°ë§Œ í•¨
            await loadSchedulesFromLocalStorage();

            // í”„ë¡œì íŠ¸ ì„ íƒ ì˜µì…˜ ìƒì„±
            const projectSelect = document.getElementById('projectSelect');
            PROJECTS.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                projectSelect.appendChild(option);
            });

            // ì›” ì„ íƒ ì˜µì…˜ ìƒì„± (ìµœê·¼ 12ê°œì›”)
            const monthSelect = document.getElementById('monthSelect');
            const today = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const option = document.createElement('option');
                option.value = `${year}-${String(month).padStart(2, '0')}`;
                option.textContent = `${year}ë…„ ${month}ì›”`;
                if (i === 0) option.selected = true;
                monthSelect.appendChild(option);
            }

            // ì´ˆê¸° ë Œë”ë§
            renderTeamGrid();
        }

        // localStorageì—ì„œ ìŠ¤ì¼€ì¤„ ë¡œë“œ (entire_calendar.htmlê³¼ ë™ì¼í•œ ë¡œì§)
        async function loadSchedulesFromLocalStorage() {
            const saved = localStorage.getItem('projectSchedules');
            if (!saved) {
                console.log('âš ï¸ projectSchedulesê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const data = JSON.parse(saved);
                const schedules = data.schedules || [];

                console.log('ğŸ“¥ ì €ì¥ëœ ìŠ¤ì¼€ì¤„ ë¡œë“œ:', schedules.length, 'ê°œ');

                // ì‚¬ìš©ì ë§¤í•‘ (ì´ë¦„ -> user ID)
                const userMapping = {};
                if (typeof USERS_DATA !== 'undefined') {
                    USERS_DATA.users.forEach(user => {
                        userMapping[user.name] = user.id;
                    });
                }

                // ì‚¬ìš©ì ì´ë¦„ì„ user IDë¡œ ë§¤í•‘í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
                function getUserByName(userName) {
                    for (const [userId, userInfo] of Object.entries(USERS)) {
                        if (userInfo.name === userName) {
                            return userId;
                        }
                    }
                    return null;
                }

                // ì¹´í…Œê³ ë¦¬ ë§¤í•‘ í•¨ìˆ˜ (entire_calendar.htmlì˜ getCategoryFromTaskì™€ ë™ì¼)
                function getCategoryFromTask(task) {
                    const ëŒ€ë¶„ë¥˜ = task.ëŒ€ë¶„ë¥˜ || task.task?.ëŒ€ë¶„ë¥˜ || '';
                    return getCategoryFromMajor(ëŒ€ë¶„ë¥˜);
                }

                TASK_ASSIGNMENTS = [];
                let addedCount = 0;
                
                schedules.forEach(schedule => {
                    const task = schedule.task || {};
                    const userName = schedule.userName || schedule.user;
                    const userId = userMapping[userName] || getUserByName(userName);

                    if (!userId) {
                        // ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš° ê²½ê³ ë§Œ ì¶œë ¥í•˜ê³  ìŠ¤í‚µ
                        console.warn('âš ï¸ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', userName, '- ìŠ¤ì¼€ì¤„ì´ ìŠ¤í‚µë©ë‹ˆë‹¤.');
                        return;
                    }

                    // entire_calendar.htmlê³¼ ë™ì¼í•œ ì¹´í…Œê³ ë¦¬ ë§¤í•‘ ì‚¬ìš©
                    const category = getCategoryFromTask(task);
                    const hours = schedule.assignedHours || calculateHours(schedule.startTime, schedule.endTime, schedule.startDate, schedule.endDate);

                    // TASKSì— ì¶”ê°€ (entire_calendar.htmlê³¼ ë™ì¼í•œ ë¡œì§)
                    if (!TASKS[schedule.taskId]) {
                        TASKS[schedule.taskId] = {
                            taskId: schedule.taskId,
                            title: task.ì†Œë¶„ë¥˜ || task.ì¤‘ë¶„ë¥˜ || task.title || 'í…ŒìŠ¤í¬',
                            category: category,
                            totalHours: task.í• ë‹¹ì‹œê°„ || task.ê¸°ì¤€ì‹œê°„ || 0,
                            projectId: task.projectId || schedule.task?.projectId || 'project-unknown'
                        };
                    }

                    TASK_ASSIGNMENTS.push({
                        taskId: schedule.taskId,
                        user: userId,
                        startDate: schedule.startDate,
                        endDate: schedule.endDate,
                        startTime: schedule.startTime,
                        endTime: schedule.endTime,
                        assignedHours: hours,
                        category: category,
                        projectId: task.projectId || schedule.task?.projectId || 'project-unknown',
                        task: task // task ê°ì²´ë„ í•¨ê»˜ ì €ì¥
                    });
                    
                    addedCount++;
                });

                console.log('âœ… ìŠ¤ì¼€ì¤„ ë¡œë“œ ì™„ë£Œ - TASK_ASSIGNMENTS:', TASK_ASSIGNMENTS.length, 'ê°œ (ìƒˆë¡œ ì¶”ê°€:', addedCount, 'ê°œ)');
            } catch (error) {
                console.error('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì‹œê°„ ê³„ì‚°
        function calculateHours(startTime, endTime, startDate, endDate) {
            const start = new Date(`${startDate}T${startTime}`);
            const end = new Date(`${endDate}T${endTime}`);
            return (end - start) / (1000 * 60 * 60);
        }

        // íŠ¹ì • ë‚ ì§œì˜ ìŠ¤ì¼€ì¤„ ê°€ì ¸ì˜¤ê¸° (entire_calendar.htmlê³¼ ë™ì¼í•œ ë¡œì§)
        function getSchedulesForDate(dateStr, userId, projectId) {
            const schedules = [];
            
            TASK_ASSIGNMENTS.forEach(assignment => {
                // userId í•„í„°ë§
                if (userId && assignment.user !== userId) return;
                
                // projectId í•„í„°ë§
                if (projectId && projectId !== 'all') {
                    const assignmentProjectId = assignment.projectId || assignment.task?.projectId;
                    if (assignmentProjectId !== projectId) return;
                }
                
                // ë‚ ì§œê°€ ë²”ìœ„ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸ (entire_calendar.htmlê³¼ ë™ì¼)
                const targetDate = new Date(dateStr);
                const startDate = new Date(assignment.startDate);
                const endDate = new Date(assignment.endDate);
                
                if (targetDate >= startDate && targetDate <= endDate) {
                    // entire_calendar.htmlê³¼ ë™ì¼: TASKSì—ì„œ ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
                    const task = TASKS[assignment.taskId];
                    if (!task) return;
                    
                    // ì¹´í…Œê³ ë¦¬ëŠ” TASKSì—ì„œ ê°€ì ¸ì˜´ (entire_calendar.htmlê³¼ ë™ì¼)
                    const category = task.category || assignment.category || 'planning';
                    
                    schedules.push({
                        taskId: assignment.taskId,
                        user: assignment.user,
                        category: category,
                        assignedHours: assignment.assignedHours || 0,
                        task: assignment.task || {}
                    });
                }
            });
            
            return schedules;
        }

        // íŠ¹ì • ë‚ ì§œì˜ ì§€ë°°ì  ì¹´í…Œê³ ë¦¬ ì°¾ê¸° (entire_calendar.htmlê³¼ ë™ì¼í•œ ë¡œì§)
        function getDominantCategory(dateStr, userId, projectId) {
            const schedules = getSchedulesForDate(dateStr, userId, projectId);
            if (schedules.length === 0) return null;

            // ì¹´í…Œê³ ë¦¬ë³„ ì‹œê°„ í•©ê³„
            const categoryHours = {};
            schedules.forEach(schedule => {
                // getSchedulesForDateì—ì„œ ì´ë¯¸ categoryë¥¼ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                let category = schedule.category;
                
                // categoryê°€ ì—†ìœ¼ë©´ fallback
                if (!category) {
                    const task = schedule.task || {};
                    const ëŒ€ë¶„ë¥˜ = task.ëŒ€ë¶„ë¥˜ || '';
                    if (ëŒ€ë¶„ë¥˜) {
                        category = getCategoryFromMajor(ëŒ€ë¶„ë¥˜);
                    } else if (schedule.taskId && TASKS[schedule.taskId]) {
                        category = TASKS[schedule.taskId].category;
                    } else {
                        category = 'planning'; // ê¸°ë³¸ê°’
                    }
                }
                
                // ì¹´í…Œê³ ë¦¬ ê°’ ì •ê·œí™” (ì¼ê´€ì„± ìœ ì§€)
                if (category === 'operations') category = 'operation';
                
                const hours = schedule.assignedHours || 0;
                categoryHours[category] = (categoryHours[category] || 0) + hours;
            });

            // ê°€ì¥ ë§ì€ ì‹œê°„ì„ ì°¨ì§€í•˜ëŠ” ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
            let dominantCategory = null;
            let maxHours = 0;
            Object.keys(categoryHours).forEach(category => {
                if (categoryHours[category] > maxHours) {
                    maxHours = categoryHours[category];
                    dominantCategory = category;
                }
            });

            return dominantCategory;
        }

        // ì›”ì˜ ëª¨ë“  ë‚ ì§œì— ëŒ€í•œ ì¹´í…Œê³ ë¦¬ ë¸”ë¡ ìƒì„±
        function getCategoryBlocksForMonth(year, month, userId, projectId) {
            const lastDate = new Date(year, month, 0).getDate();
            const blocks = [];

            for (let date = 1; date <= lastDate; date++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const category = getDominantCategory(dateStr, userId, projectId);
                blocks.push({
                    date: date,
                    dateStr: dateStr,
                    category: category
                });
            }

            return blocks;
        }

        // íŒ€ì› ê·¸ë¦¬ë“œ ë Œë”ë§
        function renderTeamGrid() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const selectedProject = document.getElementById('projectSelect').value;
            const [year, month] = selectedMonth.split('-').map(Number);

            // í˜„ì¬ ì‚¬ìš©ìì˜ íŒ€ì›ë§Œ í•„í„°ë§
            const teamMembers = [];
            if (typeof USERS_DATA !== 'undefined') {
                USERS_DATA.users.forEach(user => {
                    if (user.team === currentUser.team && user.role === 'user') {
                        teamMembers.push(user);
                    }
                });
            }

            const teamGrid = document.getElementById('teamGrid');
            teamGrid.innerHTML = '';

            teamMembers.forEach(member => {
                const blocks = getCategoryBlocksForMonth(year, month, member.id, selectedProject);
                const card = createMemberCard(member, blocks, year, month);
                teamGrid.appendChild(card);
            });
        }

        // íŒ€ì› ì¹´ë“œ ìƒì„±
        function createMemberCard(member, blocks, year, month) {
            const card = document.createElement('div');
            card.className = 'team-member-card';

            const firstDay = new Date(year, month - 1, 1);
            const firstDayOfWeek = firstDay.getDay();
            const lastDate = new Date(year, month, 0).getDate();

            // ìš”ì¼ í—¤ë”
            const weekdayHeader = document.createElement('div');
            weekdayHeader.className = 'weekday-header';
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            weekdays.forEach(day => {
                const cell = document.createElement('div');
                cell.className = 'weekday-cell';
                cell.textContent = day;
                weekdayHeader.appendChild(cell);
            });

            // ë‚ ì§œ ê·¸ë¦¬ë“œ
            const dateGrid = document.createElement('div');
            dateGrid.className = 'date-grid';

            // ì²« ì£¼ì˜ ë¹ˆ ì…€
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'date-cell';
                dateGrid.appendChild(emptyCell);
            }

            // ë‚ ì§œ ì…€
            blocks.forEach(block => {
                const cell = document.createElement('div');
                cell.className = 'date-cell';
                if (block.category) {
                    cell.classList.add('has-tasks');
                    cell.classList.add(`category-${block.category}`);
                }

                const dateNumber = document.createElement('div');
                dateNumber.className = 'date-number';
                dateNumber.textContent = block.date;
                cell.appendChild(dateNumber);

                dateGrid.appendChild(cell);
            });

            // ë©¤ë²„ í—¤ë”
            const memberHeader = document.createElement('div');
            memberHeader.className = 'member-header';
            const memberInfo = document.createElement('div');
            const memberName = document.createElement('div');
            memberName.className = 'member-name';
            memberName.textContent = member.name;
            const memberDept = document.createElement('div');
            memberDept.className = 'member-dept';
            memberDept.textContent = member.department || member.affiliation || '';
            memberInfo.appendChild(memberName);
            memberInfo.appendChild(memberDept);
            memberHeader.appendChild(memberInfo);

            card.appendChild(memberHeader);
            card.appendChild(weekdayHeader);
            card.appendChild(dateGrid);

            return card;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('projectSelect').addEventListener('change', renderTeamGrid);
        document.getElementById('monthSelect').addEventListener('change', renderTeamGrid);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>

